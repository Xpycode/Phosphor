# Session: 2026-01-31

## Goal
Clean up redundant UI elements and implement canvas-aware preview

## Progress

### UI Cleanup
- [x] Consolidated redundant import prompts:
  - Removed "Import images to preview" from PreviewPane (was duplicate)
  - Removed "Import Images" button from TimelinePane empty state
  - Kept single `+ Import` button in toolbar
- [x] Simplified empty states to subtle visual hints only

### Canvas Section Redesign
- [x] Renamed "Resize" section to "Canvas"
- [x] Renamed "Auto" mode to "Original" (clearer intent)
- [x] Removed "Enable Resize" toggle - canvas options always visible
- [x] Modes now: Original / Preset / Custom
  - **Original**: Uses source image dimensions (no scaling)
  - **Preset**: Format-specific sizes (720p, 1080p, etc.)
  - **Custom**: User-specified dimensions
- [x] Scale mode (Fit/Fill) only shows for Preset/Custom

### Canvas-Aware Preview
- [x] Fixed `automaticCanvasSize` never being set (added calculation on import)
- [x] Preview now shows actual canvas aspect ratio when Preset/Custom selected
- [x] Fill mode: shows image cropped to canvas bounds
- [x] Fit mode: shows letterbox with background color
- [x] Added subtle white border to indicate canvas bounds
- [x] Fixed live update issue: PreviewPane now observes ExportSettings directly

## Technical Details

### SwiftUI Nested ObservableObject Pattern
When `appState.exportSettings.canvasMode` changes, `appState` doesn't re-publish. Solution: observe both objects:
```swift
struct PreviewPane: View {
    @ObservedObject var appState: AppState
    @ObservedObject var settings: ExportSettings  // Direct observation
}
```

### Canvas Preview Logic
```swift
// Canvas size scaled to fit within preview area at 90%
let canvasSize = calculateCanvasSize(aspectRatio: 16/9, availableSize: geometry.size)

// Image inside canvas uses Fit or Fill content mode
Image(nsImage).aspectRatio(contentMode: settings.scaleMode == .fill ? .fill : .fit)
    .frame(width: canvasSize.width, height: canvasSize.height)
    .clipped()
```

## Files Modified
- `AppState.swift` - added `updateAutomaticCanvasSize()` method
- `ContentView.swift` - pass exportSettings to PreviewPane
- `ExportSettings.swift` - renamed `.automatic` to `.original`, updated logic
- `PreviewPane.swift` - complete rewrite with canvas-aware preview
- `ResizeSection.swift` - renamed to Canvas, removed toggle
- `TimelinePane.swift` - simplified empty state

## Git
- Commit: `89d73af` - "feat(canvas): add canvas-aware preview with live Fit/Fill visualization"
- Commit: `1b913d5` - "docs: add session log for 2026-01-31 and update project state"
- Fixed missing remote, force pushed to overwrite old 6-pane code
- Deleted 16 stale branches, clean repo now (main only)

## Decisions
- **Single import entry point**: Toolbar button only, no redundant prompts
- **"Original" over "Auto"**: Clearer that no resizing happens
- **Preview reflects export**: Users see exactly what they'll get before exporting

## Test Results
- ‚úÖ GIF export works with canvas-aware preview (Fit/Fill modes)

---

## Session 2 (Later)

### Goal
Visual polish for empty app state

### Progress

#### Visual Hierarchy Improvements
- [x] Added `Divider()` between preview and timeline sections
- [x] Changed TimelineToolbar background to `.underPageBackgroundColor`
- [x] Changed TimelinePane background to `.textBackgroundColor.opacity(0.3)`
- [x] Wrapped timeline section in VStack with shared darker background

#### HIG Review
- [x] Analyzed current UI against Apple Human Interface Guidelines
- [x] Identified improvements: material backgrounds, empty states, drop zone feedback
- [x] Validated timeline toolbar position (contextual toolbars near content = correct)

#### Created Implementation Plan
- [x] Created `docs/PLAN_HIG_UI_IMPROVEMENTS.md` with 5 improvements:
  1. Inspector material background (`.thickMaterial`)
  2. Sidebar compaction (reduce spacing, DisclosureGroups)
  3. `ContentUnavailableView` for empty states
  4. Drop zone visual feedback
  5. Timeline toolbar position (validated, no change)

### Files Modified
- `ContentView.swift` - added dividers, background wrapper
- `Views/TimelineToolbar.swift` - changed background color
- `Views/TimelinePane.swift` - changed background color

### Research Notes
- SwiftUI `Material` types: `.ultraThin`, `.thin`, `.regular`, `.thick`, `.ultraThick`
- `ContentUnavailableView` available macOS 14.0+ with label/description/actions
- HIG says sidebars (leading edge) vs inspectors (trailing edge) ‚Äî our right panel is correctly an inspector
- Liquid Glass is macOS 26+ design language (future consideration)

### Decisions
- **Keep timeline toolbar contextual**: HIG validates toolbars near content they control
- **Use `.thickMaterial` for inspector**: More opaque = better text contrast for settings panel
- **Sidebar compaction via spacing reduction**: Quick win before restructuring to Form

---

## Session 3 (Night)

### Goal
Implement HIG UI improvements from plan

### Progress

#### Wave-Based Execution
Used `/execute` pattern with parallel subagents for implementation:

**Wave 1 (parallel):**
- [x] Sidebar compaction ‚Äî reduced spacing (16‚Üí10 between sections, 12‚Üí8 internal, 8‚Üí4 top padding)
- [x] Removed redundant Dividers from TimingSection and QualitySection
- [x] ~~Material background~~ ‚Äî reverted per user preference (opaque is fine)

**Wave 2 (parallel):**
- [x] `ContentUnavailableView` for PreviewPane empty state ("No Images")
- [x] `ContentUnavailableView` for TimelinePane empty state ("Drop Images")
- [x] Drop zone visual feedback ‚Äî blue accent border + tint on drag

**Wave 3:**
- [x] Build verification ‚Äî all changes compile

#### Bug Fixes
- [x] Removed duplicate Import button (ContentUnavailableView had one, toolbar already had one)
- [x] Fixed export button not updating when format changes ‚Äî SettingsSidebar now observes `exportSettings` directly

#### Keyboard Shortcuts
- [x] ‚åòO / ‚åòI ‚Äî Import images
- [x] ‚åòE ‚Äî Export (disabled when no frames or exporting)

### Files Modified
- `PhosphorApp.swift` ‚Äî added FocusedValue keys and menu commands
- `ContentView.swift` ‚Äî provides focused values for import/export actions
- `SettingsSidebar.swift` ‚Äî observes exportSettings for reactivity
- `PreviewPane.swift` ‚Äî ContentUnavailableView empty state
- `TimelinePane.swift` ‚Äî ContentUnavailableView + drop zone overlay
- `FormatSelectionSection.swift` ‚Äî spacing compaction
- `TimingSection.swift` ‚Äî spacing compaction, removed Divider
- `QualitySection.swift` ‚Äî spacing compaction, removed Divider
- `ColorDepthSection.swift` ‚Äî spacing compaction
- `ResizeSection.swift` ‚Äî spacing compaction

### Git
- Commit: `d7995e8` ‚Äî "feat: HIG UI improvements + keyboard shortcuts"

### Test Results
- ‚úÖ APNG export works
- ‚úÖ Keyboard shortcuts work (‚åòO, ‚åòI, ‚åòE)
- ‚úÖ Export button updates immediately on format change
- ‚úÖ Drop zone highlights on drag

---

## Session 4 (Night)

### Goal
Implement WebP export support

### Research
- Apple's ImageIO can **decode** animated WebP but cannot **encode** it
- Need third-party library wrapping Google's libwebp
- Evaluated options:
  - **webp.swift** (awxkee) ‚Äî Clean API, SPM-ready, MIT, chosen ‚úì
  - SDWebImageWebPCoder ‚Äî Heavier, part of SDWebImage ecosystem
  - WebPKit ‚Äî No animated support yet

### Implementation (Wave-Based Execution)

**Wave 1 (parallel):**
- [x] Added webp.swift SPM dependency (v1.1.2 + libwebp-ios)
- [x] Created `WebPExporter.swift` using `WebPAnimatedEncoder`

**Wave 2:**
- [x] Wired `.webp` case in `AppState.performExport()`
- [x] Enabled WebP in format picker (removed "not implemented" filter)

**Wave 3:**
- [x] Build verification ‚Äî SUCCEEDED
- [x] Manual test ‚Äî WebP export works

### Technical Details

**Key differences from GIF/APNG:**
| Aspect | GIF/APNG | WebP |
|--------|----------|------|
| API | ImageIO (`CGImageDestination`) | libwebp (`WebPAnimatedEncoder`) |
| Quality | 0.0-1.0 | 0-100 |
| Duration | Seconds | Milliseconds |
| Output | Direct to URL | Data ‚Üí write to URL |

```swift
let encoder = WebPAnimatedEncoder()
try encoder.create(config: .preset(.picture, quality: webpQuality), width: w, height: h)
try encoder.addImage(image: nsImage, duration: durationMs)
let data = try encoder.encode(loopCount: loopCount)
try data.write(to: url)
```

### Files Modified
- `Phosphor.xcodeproj/project.pbxproj` ‚Äî SPM package reference
- `Services/WebPExporter.swift` ‚Äî Full implementation
- `AppState.swift` ‚Äî WebP export case
- `Models/ExportSettings.swift` ‚Äî Enabled WebP in picker

### Git
- Commit: `2bcd73f` ‚Äî "feat(export): add animated WebP export support"

### Test Results
- ‚úÖ WebP export works with all canvas modes (Original/Preset/Custom)
- ‚úÖ All 3 formats now available: GIF | WebP | APNG

## Next
- [x] Consider aspect ratio lock for Custom canvas mode
- [ ] App icon

---

## Session 5

### Goal
Implement aspect ratio lock for Custom canvas mode

### Research
- [SF Symbols](https://developer.apple.com/sf-symbols/) - `link` icon for toggle
- [SwiftUI aspectRatio](https://developer.apple.com/documentation/swiftui/view/aspectratio(_:contentmode:)-771ow) for ratio math
- Industry patterns from [Figma](https://forum.figma.com/t/constrain-proportions-when-changing-width-height-variable-of-a-component-icon/46650) and [Adobe InDesign](https://community.adobe.com/t5/indesign-discussions/issue-with-constrain-proportions-in-indesign-2025-20-0/td-p/14933789)

### Plan Created
See `docs/PLAN_ASPECT_RATIO_LOCK.md`

**UI Design:**
```
Width:   [____640____] px
            üîó              ‚Üê Toggle (bright=locked, dim=unlocked)
Height:  [____480____] px
```

**Implementation Waves:**
1. Model: `aspectRatioLocked`, `lockedAspectRatio`, helper methods
2. UI: Lock toggle button between fields
3. Logic: Custom bindings that update linked field
4. Init: Auto-populate from source image dimensions

### Implementation (Wave-Based Execution)

**Wave 1 (parallel):**
- [x] Model: Added `aspectRatioLocked`, `lockedAspectRatio`, `customAspectRatio` to ExportSettings
- [x] Model: Added `captureAspectRatio()`, `updateWidthFromHeight()`, `updateHeightFromWidth()`
- [x] UI: Redesigned `customDimensionsSection` with link toggle between fields
- [x] UI: Custom bindings for width/height that update linked field when locked
- [x] Init: `initializeCustomDimensionsIfNeeded()` populates from source image

**Wave 2:**
- [x] Build verification ‚Äî BUILD SUCCEEDED

### Files Modified
- `Models/ExportSettings.swift` ‚Äî aspect ratio properties and methods (~25 lines)
- `Views/Settings/ResizeSection.swift` ‚Äî lock toggle UI and bindings (~80 lines)

### Git
- Commit: `507f0f8` ‚Äî "feat(canvas): add aspect ratio lock for Custom mode"

### Decisions
- Use `link` SF Symbol with opacity toggle (1.0 locked, 0.4 unlocked)
- Lock enabled by default when switching to Custom mode
- Capture aspect ratio from current dimensions when locking
- Use `round()` to avoid fractional pixels

---

## Session 6

### Goal
Research and plan per-frame transform feature (move, scale, rotate)

### Research Conducted

**Sources consulted:**
- [Apple SwiftUI Gesture Documentation](https://developer.apple.com/documentation/swiftui/gesture) ‚Äî DragGesture, RotateGesture, SimultaneousGesture
- [SwiftUI RotateGesture](https://developer.apple.com/documentation/SwiftUI/RotateGesture) ‚Äî rotation gesture patterns
- [Apple Motion Transform Handles](https://support.apple.com/en-kg/guide/motion/motn227c21ee/mac) ‚Äî standard transform UX
- [Ezgif Frame-by-Frame Positioning](https://ezgif.com/add-image) ‚Äî web tool per-frame approach
- [SwiftUI BoundingBox Implementation](https://github.com/littleossa/BoundingBox) ‚Äî reference SwiftUI code
- [Hacking with Swift Gestures](https://www.hackingwithswift.com/books/ios-swiftui/how-to-use-gestures-in-swiftui) ‚Äî gesture combining
- [Kodeco SwiftUI Rotating Views](https://www.kodeco.com/books/swiftui-cookbook/v1.0/chapters/5-rotating-views-with-gestures-in-swiftui)
- [Design+Code Drag Gesture](https://designcode.io/swiftui-handbook-drag-gesture/)
- Context7 SwiftUI documentation ‚Äî DragGesture, SimultaneousGesture patterns

**Key findings:**
| Aspect | Standard Pattern | Our Approach |
|--------|------------------|--------------|
| Rotation | RotateGesture + handle | 90¬∞ buttons (simpler) |
| Position | DragGesture | Drag in preview + numeric fields |
| Scale | MagnifyGesture | Slider 50-200% |
| Anchor | Center pivot | Anchor grid presets (sets offset) |

### User Requirements Clarified
1. **Rotation:** 90¬∞ increments only (covers orientation fixes)
2. **Position:** Anchor presets + offset (intuitive approach)
3. **Interaction:** Both numeric inputs AND direct manipulation
4. **Batch:** Per-frame and "Apply to All" capability

### Deliverable
Created comprehensive implementation plan:
`docs/PLAN_PHASE11_TRANSFORMS.md`

**Plan covers:**
- `FrameTransform` data model (rotation, scale, offsetX, offsetY)
- Transform Section UI for settings sidebar
- 9-point anchor grid for quick positioning
- Preview pane drag gesture for direct manipulation
- Export pipeline integration (rotate ‚Üí scale ‚Üí position ‚Üí canvas)
- 4 implementation phases (~450 lines estimated)

### Decisions
- **90¬∞ buttons over gesture rotation:** User requirement, simpler implementation
- **Anchor presets as offset shortcuts:** Grid calculates offset values, doesn't change coordinate system
- **Offset from center:** (0,0) = centered, intuitive for most use cases
- **Transform before canvas resize:** Rotate/scale/position, then apply Fit/Fill

## Next
- [ ] Implement Phase 11a: Model + Sidebar Controls
- [ ] Implement Phase 11b: Anchor Presets + Batch
- [ ] Implement Phase 11c: Preview Direct Manipulation
- [ ] Implement Phase 11d: Export Integration
- [ ] App icon
