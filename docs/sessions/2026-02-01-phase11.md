# Session: 2026-02-01 (Phase 11 Implementation)

## Goal
Implement Phase 11 features: Undo/Redo, Per-Frame Timing, Export Dialog

## Completed

### M1: Undo/Redo System ✅
- Created `Undo/` folder with Command pattern implementation
- Files: `Command.swift`, `CommandError.swift`, `PhosphorUndoManager.swift`
- Commands: `ImportFramesCommand`, `DeleteFrameCommand`, `ReorderFramesCommand`, `ToggleMuteCommand`, `TransformCommand`
- Added `undoManager` and `isImporting` to AppState
- Wired ⌘Z/⌘⇧Z in PhosphorApp.swift Edit menu

### M2: Per-Frame Timing ✅
- Added `customDelay: Double?` to ImageItem (nil = inherit global)
- Created `FrameTimingSection.swift` (slider 10-2000ms, Reset to Global button)
- Modified playback to use per-frame timing via `scheduleNextFrame()`
- Added `buildPerFrameDelays()` helper for export
- Wired perFrameDelays to all three exporters (GIF, APNG, WebP)

### M3: Export Dialog ✅
- Created `Models/ExportState.swift` enum (idle/configuring/exporting/completed/failed)
- Created `Views/Export/` folder with 5 views:
  - `ExportSheet.swift` - main orchestrator
  - `ExportSettingsView.swift` - format/quality pickers
  - `ExportProgressView.swift` - progress bar + cancel
  - `ExportCompleteView.swift` - success + Show in Finder
  - `ExportFailedView.swift` - error display
- Modified SettingsSidebar:
  - Removed Format, Quality, ColorDepth sections (moved to export sheet)
  - Added Export button that opens sheet
  - Sidebar now shows: Transform, FrameTiming, Timing, Canvas
- Added `executeExportWithProgress()` method to AppState

## Files Created
```
Phosphor/Undo/Command.swift
Phosphor/Undo/CommandError.swift
Phosphor/Undo/PhosphorUndoManager.swift
Phosphor/Undo/Commands/ImportFramesCommand.swift
Phosphor/Undo/Commands/DeleteFrameCommand.swift
Phosphor/Undo/Commands/ReorderFramesCommand.swift
Phosphor/Undo/Commands/ToggleMuteCommand.swift
Phosphor/Undo/Commands/TransformCommand.swift
Phosphor/Views/Settings/FrameTimingSection.swift
Phosphor/Models/ExportState.swift
Phosphor/Views/Export/ExportSheet.swift
Phosphor/Views/Export/ExportSettingsView.swift
Phosphor/Views/Export/ExportProgressView.swift
Phosphor/Views/Export/ExportCompleteView.swift
Phosphor/Views/Export/ExportFailedView.swift
```

## Files Modified
- `AppState.swift` - undoManager, isImporting, per-frame timing, export methods
- `ImageItem.swift` - customDelay property
- `SettingsSidebar.swift` - removed sections, added export sheet
- `PhosphorApp.swift` - Edit menu with Undo/Redo commands
- `ContentView.swift` - focused values for undo/redo

## Build Status
✅ Build succeeds

## Next Session
1. **QA Testing needed:**
   - Test Undo/Redo (⌘Z/⌘⇧Z) for import, delete, reorder, mute, transform
   - Test per-frame timing playback and export
   - Test export dialog flow (settings → progress → complete/failed)

2. **Remaining from PLAN.md:**
   - Wave 4: Documentation updates (CLAUDE.md index, architecture diagram)
   - Delete PLAN.md after verification

3. **Optional polish:**
   - App termination handling during export (M3 spec item)
   - Delete obsolete section files if not needed

## Technical Notes
- Commands store UUIDs, not indices (stable across reorder)
- Per-frame delay stored in ms, converted to seconds for exporters
- Export sheet uses `.interactiveDismissDisabled()` during export
- buildPerFrameDelays() returns nil when no custom delays (optimization)
