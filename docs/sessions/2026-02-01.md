# Session: 2026-02-01

## Goal
Plan Phase 11 features: Undo/Redo system, Export Dialog, and Per-Frame Timing support.

## Progress
- Discussed UNDO functionality requirements (full undo for every action)
- Discussed sidebar order of operations - agreed to move Format/Quality to export dialog
- Explored QuickMotion's export dialog pattern as reference
- Confirmed per-frame timing is needed (exporters already support it, just needs UI/model)
- Created comprehensive implementation plan using planner skill
- Plan went through Technical Writer scrub (enriched comments)
- Plan went through Quality Review (addressed critical findings):
  - Added error handling with `throws` on Command protocol
  - Added `isImporting` flag to prevent async race conditions
  - Added `CommandError` enum for UUID lookup failures
  - Added app termination handling during export
  - Fixed temporal contamination in comments
  - Added missing Decision Log entries

## Decisions
1. **Command Pattern for Undo** - SwiftUI's UndoManager has limited @Observable support
2. **Sheet for Export Dialog** - Simpler than NSWindow, single export at a time
3. **UUID-based frame tracking** - Stable identity across reorder/delete
4. **Sidebar order**: Transform → FrameTiming → Timing → Canvas → Export button
5. **Format/Quality move to export sheet** - Separate "working" settings from "export-time" decisions
6. **10-2000ms timing range** - 10ms minimum (screen refresh), 2s maximum (practical limit)
7. **Optional customDelay** - nil = inherit global, allows Reset to Global button

## Plan Summary

### Milestone 1: Undo/Redo System
- Command protocol with `throws` for error safety
- UndoManager with 50-item stack limit
- Commands: Import, Delete, Reorder, Mute, Transform
- isImporting flag prevents race conditions

### Milestone 2: Per-Frame Timing
- Add `customDelay: Double?` to ImageItem
- FrameTimingSection with slider (10-2000ms)
- Wire perFrameDelays to exporters

### Milestone 3: Export Dialog + Sidebar Reorder
- ExportState enum (configuring → exporting → completed/failed)
- ExportSheet with Settings/Progress/Complete views
- Remove Format/Quality/ColorDepth from sidebar
- App termination handling during export

### Milestone 4: Documentation
- Update CLAUDE.md index
- Add architecture diagram

---

## Session 2 (Continuation)

### Goal
Complete Wave 4 (documentation) of Phase 11 execution.

### Progress
- Discovered M1-M3 already complete from previous session
- Verified CLAUDE.md already updated with architecture diagram
- Updated PROJECT_STATE.md to Phase 12 status
- Fixed build error: ExportSettingsView.swift referenced deleted section files
- Rewrote ExportSettingsView to inline format/quality/colordepth controls
- Build verified successful
- Committed and pushed all Phase 11 changes (c19089d)

### Files Changed
- `ExportSettingsView.swift` - Inlined format/quality/colordepth controls
- `PROJECT_STATE.md` - Updated to Phase 12
- 73 files total in commit (full Phase 11 implementation)

### Commit
```
feat(phase11): add Undo/Redo, per-frame timing, and export dialog
```

## Next
- Phase 12: QA testing of Undo/Redo, per-frame timing, export dialog
- Phase 12: App icon design
- Phase 12: User documentation

### Feedback from QA
1. **Undo works** ✅
2. **Rename "Mute" to "Disable" or "Skip"** - "Mute" is confusing for images (audio term)
3. **Reorder sidebar sections**: Canvas → Frame Timing → Transform (currently Transform is first)

---

## Session 3: Phase 12.1 - Playback Fixes & Toolbar Unification

### Goal
Fix 2 bugs and implement 4 UI improvements from Phase 12.1 plan.

### Progress

#### Bug Fixes
| Issue | Status | Fix |
|-------|--------|-----|
| Playback shows muted frames | ✅ Fixed | `advanceFrame()` now skips muted frames; added `canPlay`, `unmutedFrameCount`, `currentUnmutedPosition` properties |
| Drag-to-reorder doesn't work | ✅ Fixed | Changed `TimelinePane.swift:75` from `.onDrop(of: [.text])` to `.onDrop(of: [.plainText])` - UTType mismatch |

#### UI Improvements
| Feature | Status | Implementation |
|---------|--------|----------------|
| Unified Toolbar | ✅ Done | New `UnifiedToolbar.swift` - consolidates Add Images, scrubber, play/pause, frame counter, zoom controls |
| Frame counter format | ✅ Done | Shows "2/35 (40)" = frame 2 of 35 unmuted, 40 total |
| Empty state button | ✅ Done | TimelinePane shows "Add Images" button in empty state |
| Arrow key navigation | ✅ Done | ←/→ keys navigate unmuted frames, Space toggles playback |

#### Additional Fix
| Issue | Status | Fix |
|-------|--------|-----|
| Swift 6 concurrency warnings | ✅ Fixed | Added `@MainActor` to `Command` protocol |

### Files Changed
- `AppState.swift` - Added unmuted navigation methods, fixed playback
- `TimelinePane.swift` - Fixed UTType, improved empty state
- `ContentView.swift` - Integrated UnifiedToolbar
- `PreviewPane.swift` - Removed PlaybackControlsView overlay
- `Command.swift` - Added @MainActor for Swift 6 compliance
- **NEW** `UnifiedToolbar.swift` - Consolidated toolbar component

### Decisions
1. **Unmuted position tracking** - 1-based for display, maps to 0-based array index internally
2. **Scrubber behavior** - Live preview while scrubbing, syncs with playback when not scrubbing
3. **Keyboard focus** - Toolbar uses `.focusable()` to receive key events

## Next
- Test drag-to-reorder with undo/redo
- Test all edge cases (single frame, all muted, mute during playback)
- Consider renaming "Mute" terminology (from QA feedback)
