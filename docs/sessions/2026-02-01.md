# Session: 2026-02-01

## Goal
Plan Phase 11 features: Undo/Redo system, Export Dialog, and Per-Frame Timing support.

## Progress
- Discussed UNDO functionality requirements (full undo for every action)
- Discussed sidebar order of operations - agreed to move Format/Quality to export dialog
- Explored QuickMotion's export dialog pattern as reference
- Confirmed per-frame timing is needed (exporters already support it, just needs UI/model)
- Created comprehensive implementation plan using planner skill
- Plan went through Technical Writer scrub (enriched comments)
- Plan went through Quality Review (addressed critical findings):
  - Added error handling with `throws` on Command protocol
  - Added `isImporting` flag to prevent async race conditions
  - Added `CommandError` enum for UUID lookup failures
  - Added app termination handling during export
  - Fixed temporal contamination in comments
  - Added missing Decision Log entries

## Decisions
1. **Command Pattern for Undo** - SwiftUI's UndoManager has limited @Observable support
2. **Sheet for Export Dialog** - Simpler than NSWindow, single export at a time
3. **UUID-based frame tracking** - Stable identity across reorder/delete
4. **Sidebar order**: Transform → FrameTiming → Timing → Canvas → Export button
5. **Format/Quality move to export sheet** - Separate "working" settings from "export-time" decisions
6. **10-2000ms timing range** - 10ms minimum (screen refresh), 2s maximum (practical limit)
7. **Optional customDelay** - nil = inherit global, allows Reset to Global button

## Plan Summary

### Milestone 1: Undo/Redo System
- Command protocol with `throws` for error safety
- UndoManager with 50-item stack limit
- Commands: Import, Delete, Reorder, Mute, Transform
- isImporting flag prevents race conditions

### Milestone 2: Per-Frame Timing
- Add `customDelay: Double?` to ImageItem
- FrameTimingSection with slider (10-2000ms)
- Wire perFrameDelays to exporters

### Milestone 3: Export Dialog + Sidebar Reorder
- ExportState enum (configuring → exporting → completed/failed)
- ExportSheet with Settings/Progress/Complete views
- Remove Format/Quality/ColorDepth from sidebar
- App termination handling during export

### Milestone 4: Documentation
- Update CLAUDE.md index
- Add architecture diagram

## Next
- Execute the plan (M1 and M2 can run in parallel, M3 depends on M2)
- Or review plan at `docs/plans/phase-11-features.md` first
